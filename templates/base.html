<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo/logo.png') }}">
  <meta charset="UTF-8">
  <title>{% block title %}Catalogerr{% endblock %}</title>
  <style>
    /* Global Dark Theme */
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: #1e1e2d;
      margin: 0;
      padding: 0;
      color: #e0e0e0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar Navigation */
    .sidebar {
      width: 220px;
      background: #1f1f2e;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      box-shadow: 2px 0 8px rgba(0,0,0,0.5);
    }
    .sidebar-logo {
      width: 36px;
      margin: 8px 0 16px 16px;
      display: block;
    }
    .sidebar a {
      color: #ccc;
      text-decoration: none;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      transition: background 0.2s, color 0.2s;
      font-size: 0.95rem;
    }
    .sidebar a:hover { background: #2c2c44; color: #fff; }
    .sidebar a.active {
      background: #2c2c44;
      color: #4dabf7;
      border-left: 4px solid #4dabf7;
    }
    .sidebar a span.icon { margin-right: 10px; font-size: 1.2rem; }

    .sidebar-bottom { margin-top: auto; border-top: 1px solid #333; padding-top: 10px; }
    .task-widget { padding: 10px 16px; font-size: 0.85rem; color: #bbb; }
    .task-widget h3 { margin: 0 0 6px; font-size: 0.9rem; color: #4dabf7; }
    .task-widget ul { list-style: none; margin: 0; padding: 0; max-height: 100px; overflow-y: auto; }
    .task-widget li { margin: 4px 0; font-size: 0.8rem; color: #aaa; }
    .task-widget li.running { color: #4dabf7; }
    .task-widget li.success { color: #6fdc6f; }
    .task-widget li.failed { color: #ff6b6b; }

    /* Main Content Area */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* Topbar */
    .topbar {
      height: 50px;
      background: #2c2c44;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
      flex-shrink: 0;
    }
    .search-box input {
      background: #1e1e2d;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 6px 10px;
      color: #e0e0e0;
      width: 200px;
    }
    .search-box input:focus { outline: none; border-color: #4dabf7; }

    .profile { position: relative; }
    .profile-icon {
      width: 32px; height: 32px; border-radius: 50%;
      background: #4dabf7; display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: bold; cursor: pointer;
    }
    .dropdown {
      display: none; position: absolute; top: 40px; right: 0;
      background: #2c2c44; border: 1px solid #444; border-radius: 6px;
      min-width: 150px; z-index: 10; flex-direction: column;
    }
    .dropdown a {
      display: block; padding: 10px; color: #ddd; text-decoration: none; font-size: 0.9rem;
    }
    .dropdown a:hover { background: #3a3a55; }
    .dropdown.show { display: flex; }

    .content { flex: 1; width: 100%; padding: 24px; overflow-y: auto; box-sizing: border-box; }

    footer {
      background: #1f1f2e; color: #aaa; text-align: center;
      padding: 12px; font-size: 0.85rem; border-top: 1px solid #2c2c44; flex-shrink: 0;
    }
    footer a { color: #4dabf7; text-decoration: none; margin: 0 5px; }
    footer a:hover { text-decoration: underline; }
  </style>
  {% block styles %}{% endblock %}
</head>
<body>
<div class="sidebar">
  <a href="/" class="sidebar-logo-link">
    <img src="{{ url_for('static', filename='logo/logo.png') }}" alt="Catalogerr Logo" class="sidebar-logo">
  </a>

  <a href="/" class="{% if request.path == '/' %}active{% endif %}"><span class="icon">üìä</span> Dashboard</a>
  <a href="/catalog" class="{% if request.path.startswith('/catalog') %}active{% endif %}"><span class="icon">üìö</span> Archive Catalog</a>
  <a href="/active-catalog" class="{% if request.path.startswith('/active-catalog') %}active{% endif %}"><span class="icon">üì∫</span> Active Catalog</a>
  <a href="/api/v3/connector" class="{% if request.path.startswith('/connector') %}active{% endif %}"><span class="icon">üîå</span> Apps</a>
  <a href="/search" class="{% if request.path.startswith('/search') %}active{% endif %}"><span class="icon">üîç</span> Search</a>
  <a href="/settings" class="{% if request.path.startswith('/settings') %}active{% endif %}"><span class="icon">‚öôÔ∏è</span> Settings</a>
  <a href="/api/v3/tasks/ui" class="{% if request.path.startswith('/tasks') %}active{% endif %}"><span class="icon">üóìÔ∏è</span> Tasks</a>
  <a href="/system" class="{% if request.path.startswith('/system') %}active{% endif %}"><span class="icon">üíª</span> System</a>

  <div class="sidebar-bottom">
    <div class="task-widget">
      <h3>‚öôÔ∏è Tasks</h3>
      <ul id="task-status"><li>Idle</li></ul>
    </div>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <div class="search-box"><input type="text" placeholder="Search..." /></div>
    <div class="profile" id="profileMenu">
      <div class="profile-icon">U</div>
      <div class="dropdown" id="dropdownMenu">
        <a href="#">Account</a>
        <a href="/settings" class="{% if request.path.startswith('/settings') %}active{% endif %}">Settings</a>
        <a href="{{ url_for('auth.logout') }}">Logout</a>
      </div>
    </div>
  </div>

  <div class="content">{% block content %}{% endblock %}</div>

  <footer>
    <p>üì¶ Catalogerr ¬© {{ now.year }} ¬∑ 
      <a href="/settings">Settings</a> ¬∑ 
      <a href="/about-us">About</a> ¬∑ 
      <a href="/channel_log">Channel Logs</a> ¬∑ 
      <a href="https://github.com/CipherWorkZ/Catalogerr_live" target="_blank">GitHub</a>
    </p>
  </footer>
</div>

<!-- Shared API Helper -->
<script src="/static/js/api.js"></script>
<script>
  // Save Flask session key into localStorage
  const apiKeyFromSession = "{{ session.get('api_key', '') }}";
  if (apiKeyFromSession) localStorage.setItem("apiKey", apiKeyFromSession);

  // Live Task Updates (SSE with api_key in query string)
  const taskList = document.getElementById("task-status");
  const apiKey = localStorage.getItem("apiKey") || "";
  const evtSource = new EventSource(`/api/v3/tasks/stream?api_key=${encodeURIComponent(apiKey)}`);

  evtSource.addEventListener("start", e => {
    const data = JSON.parse(e.data);
    const li = document.createElement("li");
    li.textContent = `‚ñ∂ ${data.name} running...`;
    li.classList.add("running");
    taskList.prepend(li);
  });
  evtSource.addEventListener("complete", e => {
    const data = JSON.parse(e.data);
    const li = document.createElement("li");
    li.textContent = `‚úÖ ${data.name} finished`;
    li.classList.add("success");
    taskList.prepend(li);
  });
  evtSource.addEventListener("error", e => {
    const data = JSON.parse(e.data);
    const li = document.createElement("li");
    li.textContent = `‚ùå ${data.name} failed`;
    li.classList.add("failed");
    taskList.prepend(li);
  });

  // Profile dropdown
  const profile = document.getElementById("profileMenu");
  const dropdown = document.getElementById("dropdownMenu");
  let hideTimeout;
  profile.addEventListener("click", () => dropdown.classList.toggle("show"));
  [profile, dropdown].forEach(el => {
    el.addEventListener("mouseenter", () => {
      clearTimeout(hideTimeout); dropdown.classList.add("show");
    });
    el.addEventListener("mouseleave", () => {
      hideTimeout = setTimeout(() => dropdown.classList.remove("show"), 200);
    });
  });
  document.addEventListener("click", e => {
    if (!profile.contains(e.target)) dropdown.classList.remove("show");
  });
</script>

{% block scripts %}{% endblock %}
</body>
</html>
