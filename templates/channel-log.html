{% extends "base.html" %}
{% block title %}Changelog - Catalogerr{% endblock %}

{% block content %}
<div class="changelog-container">
  <h1 class="page-title">ğŸ“œ Catalogerr Changelog</h1>

  <!-- Latest Version -->
  <div class="changelog-entry">
    <h2>v1.1.2 <span class="date">2025-10-24 - live_build</span></h2>
    <ul>
      <li class="fixed">ğŸ› Fixed: API keys are now correctly reused from DB instead of regenerating on each login (prevents mismatched session keys).</li>
      <li class="fixed">ğŸ› Fixed: API key clearing on logout now properly closes all SSE streams and wipes <code>localStorage</code>.</li>
      <li class="changed">ğŸ”§ Improved: <code>api.js</code> updated to always nuke stale keys before saving new ones and block reconnect loops.</li>
      <li class="changed">ğŸ”§ Improved: Frontend SSE handling â€“ streams are skipped until a fresh key is confirmed after login.</li>
      <li class="changed">ğŸ”§ Login page redesigned: centered form fields, improved spacing, added logo + subtitle for better UX.</li>
      <li class="changed">ğŸ”§ Redirect flow: invalid/missing API key forces user to <code>/invalid_api</code> with clear error messaging.</li>
    </ul>
  </div>

  <!-- Previous Versions -->
  <div class="changelog-entry">
    <h2>v1.1.1 <span class="date">2025-10-24 - live_build</span></h2>
    <ul>
      <li class="changed">ğŸ”§ Frontend: All templates now consistently import <code>/static/js/api.js</code> for API helpers.</li>
      <li class="fixed">ğŸ› Fixed: Duplicate <code>apiKey</code> / <code>apiFetch</code> declarations that caused redirect loops.</li>
      <li class="fixed">ğŸ› Fixed: <code>toggleSection</code> not defined in <code>settings.html</code> due to missing script scope.</li>
      <li class="changed">ğŸ”§ Refactored: Dashboard, Tasks, Settings, and Stats pages updated to use a single API key flow (<code>X-Api-Key</code>).</li>
      <li class="changed">ğŸ”§ Reorganized project structure for easier development:</li>
      <ul>
        <li><code>services/</code> â†’ core logic (auth, tasks, jobs, settings, stats, utils)</li>
        <li><code>routes/</code> â†’ all Flask blueprints (<code>tasks.py</code>, <code>catalog.py</code>, <code>system.py</code>, etc.)</li>
        <li><code>modules/</code> â†’ connector + poster handling logic</li>
        <li><code>static/js/api.js</code> â†’ shared API helpers (fetch, SSE, key handling)</li>
        <li><code>templates/</code> â†’ cleaned up, removed inline duplicate API code</li>
      </ul>
      <li class="fixed">ğŸ› Fixed: SSE endpoints now accept <code>?api_key=</code> consistently (no more 401 spam).</li>
      <li class="changed">ğŸ”§ Version bump: internal cleanup release before adding new Phase 2 features.</li>
    </ul>
  </div>

  <div class="changelog-entry">
    <h2>v0.1.0 <span class="date">2025-10-04 - dev_build</span></h2>
    <ul>
      <li class="added">âœ¨ Added: <strong>Apps</strong> page (<code>/connector</code>) to manage external connectors (Sonarr/Radarr)</li>
      <li class="added">âœ¨ Added: Sonarr/Radarr <strong>connector UI</strong> (add/edit/test) with Sonarr-style cards, masked keys, and modal form</li>
      <li class="added">âœ¨ Added: Connector config persisted to <code>connector.yaml</code> via <code>modules.connector</code></li>
      <li class="added">âœ¨ Added: Connector APIs:
        <ul>
          <li><code>GET /api/v3/connectors</code> â€“ list connectors</li>
          <li><code>POST /api/v3/connectors</code> â€“ add/update connector</li>
          <li><code>GET /api/v3/connectors/test/&lt;app_type&gt;</code> â€“ handshake / test connection</li>
        </ul>
      </li>
      <li class="added">âœ¨ Added: Background task <code>connector_stats</code> (every 5m) to ping Sonarr/Radarr (<code>/system/status</code>, <code>/queue</code>, <code>/diskspace</code>) and store snapshots</li>
      <li class="added">âœ¨ Added: Background task <code>connector_media_sync</code> to import full libraries from Sonarr (<code>/series</code>) and Radarr (<code>/movie</code>)</li>
      <li class="added">âœ¨ Added: Background task <code>media_poster_backfill</code> to enrich posters via TMDB (fallback-safe)</li>
      <li class="added">âœ¨ Added: <strong>Active Catalog</strong> page (<code>/active-catalog</code>) powered by <code>/api/v3/catalog/active</code></li>
      <li class="added">âœ¨ Added: Active Media Detail (<code>/api/v3/catalog/active/&lt:id&gt;</code>) with deep links back to native apps</li>
      <li class="added">âœ¨ Added: UNIQUE constraint on <code>(connector_id, external_id)</code> in <code>connector_media</code> + duplicate cleanup</li>
      <li class="added">âœ¨ Added: Sidebar buttons for <strong>Apps</strong> (ğŸ”Œ) and <strong>Active Catalog</strong> (ğŸ“º)</li>
      <li class="added">âœ¨ Added: Logo integration in sidebar with clickable link back to home</li>
      <li class="added">âœ¨ Added: Favicon/logo support for browser tabs</li>
      <li class="added">âœ¨ Added: Static Changelog page to track changes and fixes</li>
      <li class="added">âœ¨ Added: API endpoint <code>/api/v3/enrich</code> to re-enrich metadata posters</li>
      <li class="added">âœ¨ Added: Poster caching with SHA1-hashed filenames in <code>/static/poster</code></li>
      <li class="added">âœ¨ Added: Automatic fallback strategy for posters (TMDB â†’ title search â†’ default)</li>
      <li class="changed">ğŸ”§ Changed: Frontend sends stored <code>apiKey</code> as <code>X-Api-Key</code>; backend auth check tightened</li>
      <li class="changed">ğŸ”§ Changed: Environment editor widgets are now collapsible and persist state with localStorage</li>
      <li class="fixed">ğŸ› Fixed: Scheduler task registration (stable IDs, correct kwargs)</li>
      <li class="fixed">ğŸ› Fixed: 404 issues for missing posters by forcing re-cache and DB update</li>
      <li class="fixed">ğŸ› Fixed: Sidebar logo sizing and alignment to left</li>
    </ul>
  </div>

  <div class="changelog-entry">
    <h2>v0.0.9 <span class="date">2025-09-28</span></h2>
    <ul>
      <li class="added">âœ¨ Added: Basic Flask API endpoints (<code>/api/v3</code> mimic)</li>
      <li class="added">âœ¨ Added: SSE stream for scan status</li>
      <li class="fixed">ğŸ› Fixed: Missing static file path in Docker</li>
      <li class="known">âš ï¸ Known: Env editor page missing collapsible widgets</li>
    </ul>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
.page-title {
  font-size: 1.8rem;
  margin-bottom: 20px;
  font-weight: 600;
  color: #4dabf7;
}
.changelog-container { display: flex; flex-direction: column; gap: 30px; }
.changelog-entry {
  background: #2a2a3c; border-radius: 10px; padding: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
}
.changelog-entry h2 { margin: 0 0 12px; font-size: 1.2rem; color: #fff; }
.changelog-entry .date { font-size: 0.9rem; color: #bbb; margin-left: 8px; }
.changelog-entry ul { list-style: none; margin: 0; padding: 0; }
.changelog-entry li { padding: 6px 0; font-size: 0.95rem; }
.added { color: #6fdc6f; }
.fixed { color: #4dabf7; }
.changed { color: #f59f00; }
.known { color: #ff6b6b; }
</style>
{% endblock %}
