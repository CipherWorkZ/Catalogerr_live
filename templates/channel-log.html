{% extends "base.html" %}
{% block title %}Changelog - Catalogerr{% endblock %}

{% block content %}
<div class="changelog-container">
  <h1 class="page-title">📜 Catalogerr Changelog</h1>

  <!-- Latest Version -->
  <div class="changelog-entry">
    <h2>v0.1.1 <span class="date">2025-10-06 - dev_build</span></h2>
    <ul>
      <li class="changed">🔧 Refactored: Moved auth, jobs, and settings logic into separate service files for cleaner structure:</li>
      <ul>
        <li><code>services/auth.py</code> – API key validation and request checks</li>
        <li><code>services/jobs.py</code> – APScheduler job hooks (<code>job_submitted</code>, <code>job_executed</code>, <code>job_error</code>)</li>
        <li><code>services/settings.py</code> – Config get/save endpoints</li>
      </ul>
      <li class="changed">🔧 Changed: <code>main.py</code> slimmed down, now imports from services instead of defining everything inline</li>
      <li class="fixed">🐛 Fixed: Circular import issue with <code>jobs.py</code> referencing <code>TASKS</code>; now only <code>tasks.py</code> holds state</li>
      <li class="fixed">🐛 Fixed: API key enforcement – all <code>/api/v3/*</code> routes now checked by <code>before_request</code> hook</li>
    </ul>
  </div>

  <!-- Previous Versions -->
  <div class="changelog-entry">
    <h2>v0.1.0 <span class="date">2025-10-04 - dev_build</span></h2>
    <ul>
      <li class="added">✨ Added: <strong>Apps</strong> page (<code>/connector</code>) to manage external connectors (Sonarr/Radarr)</li>
      <li class="added">✨ Added: Sonarr/Radarr <strong>connector UI</strong> (add/edit/test) with Sonarr-style cards, masked keys, and modal form</li>
      <li class="added">✨ Added: Connector config persisted to <code>connector.yaml</code> via <code>modules.connector</code></li>
      <li class="added">✨ Added: Connector APIs:
        <ul>
          <li><code>GET /api/v3/connectors</code> – list connectors</li>
          <li><code>POST /api/v3/connectors</code> – add/update connector</li>
          <li><code>GET /api/v3/connectors/test/&lt;app_type&gt;</code> – handshake / test connection</li>
        </ul>
      </li>
      <li class="added">✨ Added: Background task <code>connector_stats</code> (every 5m) to ping Sonarr/Radarr (<code>/system/status</code>, <code>/queue</code>, <code>/diskspace</code>) and store snapshots</li>
      <li class="added">✨ Added: Background task <code>connector_media_sync</code> to import full libraries from Sonarr (<code>/series</code>) and Radarr (<code>/movie</code>)</li>
      <li class="added">✨ Added: Background task <code>media_poster_backfill</code> to enrich posters via TMDB (fallback-safe)</li>
      <li class="added">✨ Added: <strong>Active Catalog</strong> page (<code>/active-catalog</code>) powered by <code>/api/v3/catalog/active</code></li>
      <li class="added">✨ Added: Active Media Detail (<code>/api/v3/catalog/active/&lt:id&gt;</code>) with deep links back to native apps:
        <ul>
          <li>Sonarr: <code>/series/&lt;title_slug&gt;</code></li>
          <li>Radarr: <code>/movie/&lt;external_id&gt;</code></li>
        </ul>
      </li>
      <li class="added">✨ Added: UNIQUE constraint on <code>(connector_id, external_id)</code> in <code>connector_media</code> + duplicate cleanup to keep latest row</li>
      <li class="added">✨ Added: Sidebar buttons for <strong>Apps</strong> (🔌) and <strong>Active Catalog</strong> (📺)</li>

      <li class="added">✨ Added: Logo integration in sidebar with clickable link back to home</li>
      <li class="added">✨ Added: Favicon/logo support for browser tabs</li>
      <li class="added">✨ Added: Static Changelog page to track changes and fixes</li>
      <li class="added">✨ Added: API endpoint <code>/api/v3/enrich</code> to re-enrich metadata posters</li>
      <li class="added">✨ Added: Poster caching with SHA1-hashed filenames in <code>/static/poster</code></li>
      <li class="added">✨ Added: Automatic fallback strategy for posters:
        <ul>
          <li>Lookup via TMDB ID</li>
          <li>Fallback to TMDB title search</li>
          <li>Fallback to static default poster</li>
        </ul>
      </li>
      <li class="added">✨ Added: Re-enrich task now logs how many posters were updated vs fallback</li>

      <li class="changed">🔧 Changed: Frontend sends stored <code>apiKey</code> as <code>X-Api-Token</code>; backend auth check tightened</li>
      <li class="changed">🔧 Changed: Environment editor widgets are now collapsible and persist state with localStorage</li>

      <li class="fixed">🐛 Fixed: Scheduler task registration (stable IDs, correct kwargs)</li>
      <li class="fixed">🐛 Fixed: 404 issues for missing posters by forcing re-cache and DB update</li>
      <li class="fixed">🐛 Fixed: Sidebar logo sizing and alignment to left</li>
    </ul>
  </div>

  <div class="changelog-entry">
    <h2>v0.0.9 <span class="date">2025-09-28</span></h2>
    <ul>
      <li class="added">✨ Added: Basic Flask API endpoints (<code>/api/v3</code> mimic)</li>
      <li class="added">✨ Added: SSE stream for scan status</li>
      <li class="fixed">🐛 Fixed: Missing static file path in Docker</li>
      <li class="known">⚠️ Known: Env editor page missing collapsible widgets</li>
    </ul>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
.page-title {
  font-size: 1.8rem;
  margin-bottom: 20px;
  font-weight: 600;
  color: #4dabf7;
}
.changelog-container { display: flex; flex-direction: column; gap: 30px; }
.changelog-entry {
  background: #2a2a3c; border-radius: 10px; padding: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
}
.changelog-entry h2 { margin: 0 0 12px; font-size: 1.2rem; color: #fff; }
.changelog-entry .date { font-size: 0.9rem; color: #bbb; margin-left: 8px; }
.changelog-entry ul { list-style: none; margin: 0; padding: 0; }
.changelog-entry li { padding: 6px 0; font-size: 0.95rem; }
.added { color: #6fdc6f; }
.fixed { color: #4dabf7; }
.changed { color: #f59f00; }
.known { color: #ff6b6b; }
</style>
{% endblock %}
