{% extends "base.html" %}
{% block title %}Stats - Catalogerr{% endblock %}

{% block content %}
<h1 class="page-title">📊 Collection Stats</h1>

<h2 style="color:#4dabf7; margin-top:20px;">📦 Archive / Backup</h2>
<div id="archive-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:20px; margin-bottom:30px;">
  <!-- Archive cards injected by JS -->
</div>

<h2 style="color:#4dabf7; margin-top:20px;">🔌 Active Connectors</h2>
<div id="connector-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:20px;">
  <!-- Connector cards injected by JS -->
</div>

<style>
  .page-title { font-size: 1.8rem; margin-bottom: 10px; font-weight: 600; color: #fff; }
  .stat-card { background:#2a2a3c; padding:20px; border-radius:12px; text-align:left; box-shadow:0 2px 6px rgba(0,0,0,0.6); }
  .stat-card h3 { color:#4dabf7; margin-bottom:10px; font-size:1.2rem; text-align:center; }
  .stat-card p { margin:6px 0; font-size:0.95rem; }
  .status-ok { color:#6fdc6f; font-weight:600; }
  .status-error { color:#ff6b6b; font-weight:600; }
  .queue-item { margin:6px 0; padding:6px; background:#2b2b3c; border-radius:6px; font-size:0.85rem; color:#bbb; }
  .queue-item strong { color:#fff; }
</style>

<script>
const apiKey = localStorage.getItem("apiKey");
if (!apiKey) { window.location.href = "/login"; }

function apiFetch(url, options = {}) {
  return fetch(url, {
    ...options,
    headers: {
      ...(options.headers||{}),
      "X-Api-Token": apiKey,
      "Content-Type": "application/json"
    }
  });
}

function formatSize(bytes) {
  if (!bytes) return "-";
  const units = ["B","KB","MB","GB","TB","PB"];
  let i = 0;
  while (bytes >= 1024 && i < units.length-1) { bytes /= 1024; i++; }
  return bytes.toFixed(2) + " " + units[i];
}

// --- Render queue items from connector_stats.queue JSON ---
function renderQueue(queue) {
  try {
    const q = typeof queue === "string" ? JSON.parse(queue) : queue;
    if (!q || !q.records || !q.records.length) return "<em>Empty</em>";

    return q.records.map(r => {
      const title = r.title || `S${r.seasonNumber}E${r.episodeId}`;
      const quality = r.quality?.quality?.name || "unknown";
      const status = r.status || "pending";
      const client = r.downloadClient || "";

      return `<div class="queue-item">
        📥 <strong>${title}</strong><br>
        <span style="color:#4dabf7;">${quality}</span> · 
        <span style="color:${status === "completed" ? "#6fdc6f" : "#f59f00"}">${status}</span>
        ${client ? ` · <span style="color:#bbb;">${client}</span>` : ""}
      </div>`;
    }).join("");
  } catch(e) {
    console.error("Queue parse error:", e);
    return "<em>-</em>";
  }
}

async function loadStats() {
  try {
    const res = await apiFetch("/api/v3/stats");
    if (!res.ok) throw new Error("Unauthorized or failed fetch");

    const data = await res.json();
    const archiveGrid = document.getElementById("archive-grid");
    const connectorGrid = document.getElementById("connector-grid");
    archiveGrid.innerHTML = "";
    connectorGrid.innerHTML = "";

    // --- Archive Section ---
    archiveGrid.innerHTML += `
      <div class="stat-card">
        <h3>Media Counts</h3>
        <p>🎬 Movies: <strong>${data.archive.counts.movies}</strong></p>
        <p>📺 Series: <strong>${data.archive.counts.series}</strong></p>
        <p>📂 Episodes: <strong>${data.archive.counts.episodes}</strong></p>
      </div>`;

    archiveGrid.innerHTML += `
      <div class="stat-card">
        <h3>Storage</h3>
        <p>🎬 Movies: <strong>${formatSize(data.archive.sizes.movies)}</strong></p>
        <p>📺 Series: <strong>${formatSize(data.archive.sizes.series)}</strong></p>
        <p>💽 Total: <strong>${formatSize(data.archive.sizes.total)}</strong></p>
      </div>`;

    archiveGrid.innerHTML += `
      <div class="stat-card">
        <h3>Drives</h3>
        <p>🔢 Count: <strong>${data.archive.drives.count}</strong></p>
        <p>💾 Capacity: <strong>${formatSize(data.archive.drives.capacity)}</strong></p>
      </div>`;

    // --- Connectors Section ---
    if (data.connectors && data.connectors.length) {
      data.connectors.forEach(c => {
        connectorGrid.innerHTML += `
          <div class="stat-card">
            <h3>${c.app_type || "Connector"}</h3>
            <p>ID: <strong>${c.id}</strong></p>
            <p>Status: <span class="${c.status === "success" ? "status-ok" : "status-error"}">${c.status || "-"}</span></p>
            <p>Version: <strong>${c.version || "-"}</strong></p>
            <p>Media Count: <strong>${c.media_count || 0}</strong></p>
            <p><strong>Queue:</strong><br>${renderQueue(c.queue)}</p>
            <p>Disk: <strong>${c.diskspace || "-"}</strong></p>
            <p>Last Check: <strong>${c.last_check || "-"}</strong></p>
            ${c.error ? `<p class="status-error">⚠️ ${c.error}</p>` : ""}
          </div>`;
      });
    }

  } catch (err) {
    console.error("Failed to load stats:", err);
    document.getElementById("archive-grid").innerHTML =
      `<p style="color:#ff6b6b;">❌ Could not load stats. Check API key/session.</p>`;
  }
}

loadStats();
</script>
{% endblock %}
